/*!
 * OpenSpendings BubbleChart 0.1
 *
 * Copyright (c) 2011 Gregor Aisch (http://driven-by-data.net)
 * Licensed under the MIT license
 *//*jshint undef: true, browser:true, jquery: true, devel: true *//*global Raphael, TWEEN */var OpenSpendings=OpenSpendings?OpenSpendings:{};OpenSpendings.BubbleChart=function(a,b,c,d,e){var f=this;f.container=a,f.urlOrTree=b,f.app=new OpenSpendings.BubbleChart.Main(f.container,c,d,e),typeof f.urlOrTree=="string"?f.app.loadData(f.urlOrTree):f.app.setData(f.urlOrTree)},OpenSpendings.BubbleChart.Vector=function(a,b){var c=this;c.x=a,c.y=b,this.length=function(){var a=this;return Math.sqrt(a.x*a.x+a.y*a.y)},this.normalize=function(a){var b=this,c=b.length();a||(a=1),b.x*=a/c,b.y*=a/c},this.clone=function(){var a=this;return new OpenSpendings.BubbleChart.Vector(a.x,a.y)}},OpenSpendings.BubbleChart.Loader=function(a){var b=this;b.config=a,b.loadData=function(){var a=this;a.rootNode={label:a.config.rootNodeLabel},OpenSpendings.BubbleChart.getTree(a.config.apiUrl,a.config.dataset,a.config.drilldowns,a.config.cuts,a.dataLoaded.bind(a),a.rootNode,a.config.testDataPath)},b.dataLoaded=function(a){var b=this,c=OpenSpendings.BubbleChart.buildTree(a,b.config.drilldowns,b.rootNode);b.run(c)},b.bubbleStyles={root:{color:"#999999"},10:{color:"#f4714c"},"02":{color:"#999933"},"05":{color:"#006633"},"07":{color:"#cc0066"},"03":{color:"#0099cc"},"06":{color:"#cc6666"},"08":{color:"#cccc00"},"01":{color:"#9900cc"},"09":{color:"#3333cc"},"04":{color:"#33cc33"}},b.tooltipTimer=undefined,b.setTooltip=function(a){var c=$("#bubble-chart-wrapper .tooltip"),d='<div class="header"><div class="icon"></div><div class="title">'+a.node.label+" ("+a.node.id+')</div><div class="amount">'+OpenSpendings.BubbleChart.Utils.formatNumber(a.node.amount)+"&euro;</div></div>"+'<div class="row"><a>More Information</a></div>'+'<div class="row"><a>Add to Compare-O-Tron</a></div>';c.length>0?c.html(d):(c=$('<div class="tooltip">'+d+"</div>"),$("#bubble-chart-wrapper").append(c)),$("#bubble-chart-wrapper .tooltip .icon").css({background:a.target.color}),a.mouseEventGroup.addMember(c),c.css({left:a.position.x-c.width()*.5+"px",top:a.position.y+10+"px",opacity:0}),b.tooltipTimer=new vis4.DelayedTask(2e3,this,b.showTooltip.bind(b),c)},b.showTooltip=function(a){a.animate({opacity:1},{duration:300}),a.show()},b.hideTooltip=function(a){var c=$("#bubble-chart-wrapper .tooltip");c.css({opacity:0,left:"-500px"}),c.hide(),a.mouseEventGroup.removeMember(c),b.tooltipTimer.cancel()},b.run=function(a){var b=this;window.bubbleChart=new OpenSpendings.BubbleChart(b.config.container,a,b.setTooltip.bind(b),b.hideTooltip.bind(b),b.bubbleStyles)},b.loadData()};var log=window.console?console.log:function(a,b,c,d){};OpenSpendings.BubbleChart.Main=function(a,b,c,d){var e=this;e.$container=$(a),e.onHover=b,e.onUnHover=c,e.style=d,e.ns=OpenSpendings.BubbleChart,e.nodesById={},e.displayObjects=[],e.bubbleScale=1,e.globRotation=0,e.currentYear=2010,e.currentCenter=undefined,e.currentTransition=undefined,e.loadData=function(a){$.ajax({url:a,dataType:"json",success:this.setData.bind(this)})},e.setData=function(a){var b=this;b.initData(a),b.initPaper(),b.initBubbles(),b.initTween(),b.initHistory()},e.initData=function(a){var b=this;b.traverse(a,0),b.treeRoot=a},e.traverse=function(a,b){var c,d,e,f=this;f.style.hasOwnProperty(a.id)?a.color=f.style[a.id].color:a.hasOwnProperty("color")&&a.color!==undefined?vis4.log("use data color",a.color):a.level>0?a.color=a.parent.color:a.color="#999999",vis4.log(a.id,a.color,a),a.children.length<1&&(vis4.log(a.color),a.color=vis4color.fromHex(a.color).saturation("*.86").x),a.level>0&&(e=a.parent.children,e.length>1&&(a.left=e[(b-1+e.length)%e.length],a.right=e[(Number(b)+1)%e.length],a.right==a.left&&(a.right=undefined)));if(!a.token){a.token=a.label.toLowerCase().replace(/\W/g,"-");while(f.nodesById.hasOwnProperty(a.token))a.token+="-"}f.nodesById[a.token]=a,a.maxChildAmount=0;for(c in a.children)d=a.children[c],d.parent=a,a.maxChildAmount=Math.max(a.maxChildAmount,d.amount),f.traverse(d,c)},e.initPaper=function(){var a=this,b=a.$container,c=a.treeRoot,d=Raphael(b[0],b.width(),b.height()),e=Math.min(d.width,d.height)*.5-40,f,g=OpenSpendings.BubbleChart.Vector,h=new g(d.width*.5,d.height*.5);a.paper=d,f=Math.pow((Math.pow(c.amount,.6)+Math.pow(c.maxChildAmount,.6)*2)/e,1.6666666667),a.a2radBase=OpenSpendings.BubbleChart.a2radBase=f,a.origin=h},e.initTween=function(){this.tweenTimer=setInterval(this.loop,1e3/120)},e.initBubbles=function(){vis4.log("initBubbles");var a=this,b=a.treeRoot;OpenSpendings.BubbleChart.Bubble=OpenSpendings.BubbleChart.Bubbles.Multi;var c=a.createBubble(b,a.origin,0,0,b.color);a.traverseBubbles(c)},e.traverseBubbles=function(a){var b=this,c,d=b.ns.Utils.amount2rad,e,f,g,h,i=0,j=0,k,l,m=Math.PI*2;g=a.node.children;for(e in g)f=g[e],i+=d(f.amount);g.length>0&&(c=b.createRing(a.node,a.pos,0,{stroke:"#ccc","stroke-dasharray":"- "}));for(e in g)f=g[e],k=d(f.amount)/i*m,l=j+k*.5,f.centerAngle=l,h=b.createBubble(f,a.pos,0,l,f.color),j+=k,b.traverseBubbles(h)},e.createBubble=function(a,b,c,d,e){var f=this,g=f.ns,h,i,j;j=new g.Bubble(a,f,b,c,d,e),f.displayObjects.push(j);return j},e.createRing=function(a,b,c,d){var e=this,f=e.ns,g;g=new f.Ring(a,e,b,c,d),e.displayObjects.push(g);return g},e.changeView=function(a){var b=this,c=b.paper,d=Math.min(c.height,c.width)*.5-60,e=b.ns,f=e.Utils,g=b.origin,h={stroke:"#ccc","stroke-dasharray":"- "},i={stroke:"#ccc","stroke-dasharray":". "},j=f.amount2rad,k=b.treeRoot,l=b.nodesById,m=l.hasOwnProperty(a)?l[a]:null,n=new e.Layout,o,p,q,r=Math.PI*2,s=b.getBubble.bind(b),t=b.getRing.bind(b),u=b.unifyAngle;if(m!==null){var v,w,x,y,z,A,B,C,D,E,F,G,H,I=!1,J=!1;for(q in b.displayObjects)b.displayObjects[q].hideFlag=!0;if(m==k){n.$(b).bubbleScale=1,n.$(g).x=c.width*.5,n.$(g).y=c.height*.5,v=s(k),A=j(m.amount)+j(m.maxChildAmount)+20,F=t(k),n.$(F).rad=A;for(q in m.children)z=m.children[q],o=s(z),n.$(o).angle=u(z.centerAngle+v.childRotation),n.$(o).rad=A}else{G=d/(j(m.amount)+j(m.maxChildAmount)*2),n.$(b).bubbleScale=G,v=s(m),b.currentCenter&&b.currentCenter==m.left?J=!0:b.currentCenter&&b.currentCenter==m.right&&(I=!0);var K=b.shortestAngleTo;n.$(v).angle=K(v.angle,0),A=j(m.amount)*G+j(m.maxChildAmount)*G+20,F=t(m),n.$(F).rad=A,w=s(m.parent),w.childRotation=-m.centerAngle,n.$(w).rad=0,B=c.width*.5-Math.max(c.width*.5-280-G*(j(m.parent.amount)+j(m.amount)),G*j(m.parent.amount)*-1+60),H=A+B,n.$(g).x=c.width*.5-B,n.$(g).y=c.height*.5,B+=c.width*.1,F=t(m.parent),n.$(F).rad=B,n.$(v).rad=B;for(q in m.children)z=m.children[q],o=s(z),n.$(o).angle=b.shortestAngleTo(o.angle,z.centerAngle+v.childRotation),n.$(o).rad=A;m.left&&(x=m.left,D=j(x.amount)*G,E=r-Math.asin((b.paper.height*.5+D-50)/B),o=s(x),n.$(o).rad=B,n.$(o).angle=K(o.angle,E)),m.right&&(x=m.right,D=j(x.amount)*G,E=Math.asin((b.paper.height*.5+D-50)/B),o=s(x),n.$(o).rad=B,n.$(o).angle=K(o.angle,E))}for(q in b.displayObjects){var L=b.displayObjects[q];L.hideFlag&&L.visible?(n.$(L).alpha=0,L.className=="bubble"&&L.node.level>1&&(n.$(L).rad=0),n.hide(L)):L.hideFlag||(n.$(L).alpha=1,L.visible||(L.alpha=0,n.show(L)))}p=new e.AnimatedTransitioner(1e3),p.changeLayout(n),b.currentTransition=p,b.currentCenter=m}else f.log("node "+a+" not found")},e.unifyAngle=function(a){var b=Math.PI,c=b*2;while(a>=c)a-=c;while(a<0)a+=c;return a},e.shortestAngle=function(a,b){var c=function(a){return Math.round(a/Math.PI*180)+""},d=Math.PI,f=d*2,g=e.unifyAngle;a=g(a),b=g(b);var h=b-a;h>d&&(h-=f),h<-d&&(h+=f),vis4.log("shortestAngle",c(a),c(b),c(h));return h},e.shortestAngleTo=function(a,b){return a+e.shortestAngle(a,b)},e.shortestLeftTurn=function(a,b){var c=e.shortestAngle(a,b);c>0&&(c=c-Math.PI*2);return a+c},e.shortestRightTurn=function(a,b){var c=e.shortestAngle(a,b);c<0&&(c=Math.PI*2+c);return a+c},e.getBubble=function(a){return this.getDisplayObject("bubble",a)},e.getRing=function(a){return this.getDisplayObject("ring",a)},e.getDisplayObject=function(a,b){var c=this,d,e;for(d in c.displayObjects){e=c.displayObjects[d];if(e.className!=a)continue;if(e.node==b){e.hideFlag=!1;return e}}vis4.log(a+" not found for node",b)},e.initHistory=function(){$.history.init(e.urlChanged.bind(e),{unescape:",/"})},e.freshUrl="",e.urlChanged=function(a){var b=this,c=b.currentTransition;b.freshUrl=a,c&&c.running?(vis4.log("transition is running at the moment, adding listener"),c.onComplete(b.changeUrl.bind(b))):b.changeUrl()},e.changeUrl=function(){var a=this,b=a.freshUrl.split("/"),c=b[1],d=b[b.length-1],e;a.freshUrl===""&&a.navigateTo(a.treeRoot),a.nodesById.hasOwnProperty(d)?(e=a.getUrlForNode(a.nodesById[d]),a.freshUrl!=e?$.history.load(e):a.navigateTo(a.nodesById[d],!0)):a.navigateTo(a.treeRoot)},e.navigateTo=function(a,b){var c=this;b?c.changeView(a.token):$.history.load(c.getUrlForNode(a))},e.getUrlForNode=function(a){var b=[];b.push(a.token);while(a.parent)b.push(a.parent.token),a=a.parent;b.reverse();return"/"+e.currentYear+"/"+b.join("/")},this.loop=function(){TWEEN.update()}},OpenSpendings.BubbleChart.Bubbles={},OpenSpendings.BubbleChart.Bubbles.Donut=function(a,b,c,d,e,f){var g=OpenSpendings.BubbleChart,h=g.Utils,i=this;i.className="bubble",i.node=a,i.paper=b.paper,i.origin=c,i.bc=b,i.rad=d,i.angle=e,i.color=f,i.alpha=1,i.visible=!1,i.ns=g,i.bubbleRad=h.amount2rad(this.node.amount),i.childRotation=0,i.getXY=function(){var a=this,b=a.origin,c=a.angle,d=a.rad;a.pos.x=b.x+Math.cos(c)*d,a.pos.y=b.y-Math.sin(c)*d},i.init=function(){var a=this;a.pos=new OpenSpendings.BubbleChart.Vector(0,0),a.getXY();var b=[],c=0,d,e;for(d=0;d<3;d++)e=Math.random(),b.push(e),c+=e;for(d in b)b[d]=b[d]/c;vis4.log(b),a.breakdown=b,a.breakdownOpacities=[.25,.59,.4];var f=!1;a.initialized=!0},i.onclick=function(a){var b=this;b.node.children.length>0&&b.bc.navigateTo(b.node)},i.onhover=function(a){var b=this;a.node=b.node,a.position={x:b.pos.x,y:b.pos.y},b.bc.onHover(a)},i.onunhover=function(a){var b=this;a.node=b.node,a.position={x:b.pos.x,y:b.pos.y},b.bc.onUnHover(a)},this.draw=function(){var a=this,b=a.bubbleRad*a.bc.bubbleScale,c=a.pos.x,d=a.pos.y,e=a.getXY();if(!!a.visible){a.circle.attr({cx:a.pos.x,cy:a.pos.y,r:b,"fill-opacity":a.alpha}),a.node.children.length>0?a.dashedBorder.attr({cx:a.pos.x,cy:a.pos.y,r:b*.85,"stroke-opacity":a.alpha*.8}):a.dashedBorder.attr({"stroke-opacity":0});var f,g=a.pos.x,h=a.pos.y,i,j,k,l,m,n,o,p,q=b*.85,r=-Math.PI*.5,s;for(f in a.breakdown){s=a.breakdown[f]*Math.PI*2,i=g+Math.cos(r)*q,m=h+Math.sin(r)*q,j=g+Math.cos(r+s)*q,n=h+Math.sin(r+s)*q,k=g+Math.cos(r+s)*b,o=h+Math.sin(r+s)*b,l=g+Math.cos(r)*b,p=h+Math.sin(r)*b,r+=s;var t="M"+i+" "+m+" A"+q+","+q+" 0 "+(s>Math.PI?"1,1":"0,1")+" "+j+","+n+" L"+k+" "+o+" A"+b+","+b+" 0 "+(s>Math.PI?"1,0":"0,0")+" "+l+" "+p+" Z";a.breakdownArcs[f].attr({path:t,"stroke-opacity":a.alpha*.2,"fill-opacity":a.breakdownOpacities[f]*a.alpha})}b<20?a.label.hide():(a.label.show(),b<40?a.label.find(".desc").hide():a.label.find(".desc").show()),a.label.css({width:2*b+"px",opacity:a.alpha}),a.label.css({left:a.pos.x-b+"px",top:a.pos.y-a.label.height()*.5+"px"})}},this.hide=function(){var a=this,b;a.circle.remove(),a.dashedBorder.remove(),a.label.remove(),a.visible=!1;for(b in a.breakdownArcs)a.breakdownArcs[b].remove()},this.show=function(){var a=this,b;a.circle=a.paper.circle(a.pos.x,a.pos.y,a.bubbleRad*a.bc.bubbleScale).attr({stroke:!1,fill:a.color}),a.dashedBorder=a.paper.circle(a.pos.x,a.pos.y,a.bubbleRad*a.bc.bubbleScale-3).attr({stroke:"#fff","stroke-opacity":a.alpha*.4,"stroke-dasharray":"- ",fill:!1}),a.label=$('<div class="label"><div class="amount">'+h.formatNumber(a.node.amount)+'</div><div class="desc">'+a.node.label+"</div></div>"),$("#bubble-chart").append(a.label),a.node.children.length>0&&($(a.circle.node).css({cursor:"pointer"}),$(a.label).css({cursor:"pointer"})),a.breakdownArcs=[];for(b in a.breakdown){var c=a.paper.path("M 0 0 L 2 2").attr({fill:"#fff","fill-opacity":Math.random()*.4+.3,stroke:"#fff"});a.breakdownArcs.push(c)}var d=[a.circle.node,a.label];for(b in a.breakdownArcs)d.push(a.breakdownArcs[b].node);var e=new a.ns.MouseEventGroup(a,d);e.click(a.onclick.bind(a)),e.hover(a.onhover.bind(a)),e.unhover(a.onunhover.bind(a)),a.visible=!0},this.init()},OpenSpendings.BubbleChart.Bubbles.Multi=function(a,b,c,d,e,f){var g=OpenSpendings.BubbleChart,h=g.Utils,i=this;i.className="bubble",i.node=a,i.paper=b.paper,i.origin=c,i.bc=b,i.rad=d,i.angle=e,i.color=f,i.alpha=1,i.visible=!1,i.ns=g,i.bubbleRad=h.amount2rad(this.node.amount),i.childRotation=0,i.getXY=function(){var a=this,b=a.origin,c=a.angle,d=a.rad;a.pos.x=b.x+Math.cos(c)*d,a.pos.y=b.y-Math.sin(c)*d},i.init=function(){var a=this;a.pos=new OpenSpendings.BubbleChart.Vector(0,0),a.getXY();var b=[],c=0,d,e;for(d=0;d<3;d++)e=Math.random(),b.push(e),c+=e;for(d in b)b[d]=b[d]/c;a.breakdown=b,a.breakdownColors=[a.node.color,vis4color.fromHex(a.node.color).lightness(.8).x,vis4color.fromHex(a.node.color).lightness(.9).x],a.govRad=h.amount2rad(a.node.amount*b[0]);var f=!1;a.initialized=!0},i.onclick=function(a){var b=this;b.node.children.length>0&&b.bc.navigateTo(b.node)},i.onhover=function(a){var b=this;a.node=b.node,a.position={x:b.pos.x,y:b.pos.y},b.bc.onHover(a)},i.onunhover=function(a){var b=this;a.node=b.node,a.position={x:b.pos.x,y:b.pos.y},b.bc.onUnHover(a)},this.show=function(){var a=this,b;a.circle=a.paper.circle(a.pos.x,a.pos.y,a.govRad*a.bc.bubbleScale).attr({stroke:!1,fill:a.color}),a.label=$('<div class="label"><div class="amount">'+h.formatNumber(a.node.amount)+'</div><div class="desc">'+a.node.label+"</div></div>"),$("#bubble-chart").append(a.label),a.node.children.length>0&&($(a.circle.node).css({cursor:"pointer"}),$(a.label).css({cursor:"pointer"})),a.breakdownArcs=[];for(b in a.breakdown){if(b<1)continue;var c=a.paper.path("M 0 0 L 2 2").attr({fill:a.breakdownColors[b],"fill-opacity":1,stroke:!1});a.breakdownArcs.push(c)}var d=[a.circle.node,a.label];for(b in a.breakdownArcs)d.push(a.breakdownArcs[b].node);var e=new a.ns.MouseEventGroup(a,d);e.click(a.onclick.bind(a)),e.hover(a.onhover.bind(a)),e.unhover(a.onunhover.bind(a)),a.visible=!0},this.draw=function(){var a=this,b=a.bubbleRad*a.bc.bubbleScale,c=a.govRad*a.bc.bubbleScale,d=a.pos.x,e=a.pos.y,f=a.getXY();if(!!a.visible){a.circle.attr({cx:a.pos.x,cy:a.pos.y,r:c,"fill-opacity":a.alpha});var g,h=a.pos.x,i=a.pos.y,j,k,l,m,n,o,p,q,r=-Math.PI*.5,s;for(g in a.breakdown){if(g<1)continue;s=a.breakdown[g]/(1-a.breakdown[0])*Math.PI*2,j=h+Math.cos(r)*c,n=i+Math.sin(r)*c,k=h+Math.cos(r+s)*c,o=i+Math.sin(r+s)*c,l=h+Math.cos(r+s)*b,p=i+Math.sin(r+s)*b,m=h+Math.cos(r)*b,q=i+Math.sin(r)*b,r+=s;var t="M"+j+" "+n+" A"+c+","+c+" 0 "+(s>Math.PI?"1,1":"0,1")+" "+k+","+o+" L"+l+" "+p+" A"+b+","+b+" 0 "+(s>Math.PI?"1,0":"0,0")+" "+m+" "+q+" Z";a.breakdownArcs[g-1].attr({path:t,"fill-opacity":a.alpha*.5})}b<20?a.label.hide():(a.label.show(),b<40?a.label.find(".desc").hide():a.label.find(".desc").show()),a.label.css({width:2*b+"px",opacity:a.alpha}),a.label.css({left:a.pos.x-b+"px",top:a.pos.y-a.label.height()*.5+"px"})}},this.hide=function(){var a=this,b;a.circle.remove(),a.label.remove(),a.visible=!1;for(b in a.breakdownArcs)a.breakdownArcs[b].remove()},this.init()},OpenSpendings.BubbleChart.Bubbles.Pies=function(a,b,c,d,e,f){var g=OpenSpendings.BubbleChart,h=g.Utils,i=this;i.className="bubble",i.node=a,i.paper=b.paper,i.origin=c,i.bc=b,i.rad=d,i.angle=e,i.color=f,i.alpha=1,i.visible=!1,i.ns=g,i.bubbleRad=h.amount2rad(this.node.amount),i.childRotation=0,i.getXY=function(){var a=this,b=a.origin,c=a.angle,d=a.rad;a.pos.x=b.x+Math.cos(c)*d,a.pos.y=b.y-Math.sin(c)*d},i.init=function(){var a=this;a.pos=new OpenSpendings.BubbleChart.Vector(0,0),a.getXY();var b=[],c=0,d,e;for(d=0;d<3;d++)e=Math.random(),b.push(e),c+=e;for(d in b)b[d]=b[d]/c;vis4.log(b),a.breakdown=b,a.breakdownOpacities=[.25,.59,.4];var f=!1;a.initialized=!0},i.onclick=function(a){var b=this;b.node.children.length>0&&b.bc.navigateTo(b.node)},i.onhover=function(a){var b=this;a.node=b.node,a.position={x:b.pos.x,y:b.pos.y},b.bc.onHover(a)},i.onunhover=function(a){var b=this;a.node=b.node,a.position={x:b.pos.x,y:b.pos.y},b.bc.onUnHover(a)},this.draw=function(){var a=this,b=a.bubbleRad*a.bc.bubbleScale,c=a.pos.x,d=a.pos.y,e=a.getXY();if(!!a.visible){a.circle.attr({cx:a.pos.x,cy:a.pos.y,r:b,"fill-opacity":a.alpha});var f,g=a.pos.x,h=a.pos.y,i,j,k,l,m,n,o,p,q=b*.85,r=-Math.PI*.5,s;for(f in a.breakdown){s=a.breakdown[f]*Math.PI*2,i=g,m=h,k=g+Math.cos(r+s)*b,o=h+Math.sin(r+s)*b,l=g+Math.cos(r)*b,p=h+Math.sin(r)*b,r+=s;var t="M"+i+" "+m+" L"+k+" "+o+" A"+b+","+b+" 0 "+(s>Math.PI?"1,0":"0,0")+" "+l+" "+p+" Z";a.breakdownArcs[f].attr({path:t,"stroke-opacity":a.alpha*.2,"fill-opacity":a.breakdownOpacities[f]*a.alpha})}b<20?a.label.hide():(a.label.show(),b<40?a.label.find(".desc").hide():a.label.find(".desc").show()),a.label.css({width:2*b+"px",opacity:a.alpha}),a.label.css({left:a.pos.x-b+"px",top:a.pos.y-a.label.height()*.5+"px"})}},this.hide=function(){var a=this,b;a.circle.remove(),a.label.remove(),a.visible=!1;for(b in a.breakdownArcs)a.breakdownArcs[b].remove()},this.show=function(){var a=this,b;a.circle=a.paper.circle(a.pos.x,a.pos.y,a.bubbleRad*a.bc.bubbleScale).attr({stroke:!1,fill:a.color}),a.label=$('<div class="label"><div class="amount">'+h.formatNumber(a.node.amount)+'</div><div class="desc">'+a.node.label+"</div></div>"),$("#bubble-chart").append(a.label),a.node.children.length>0&&($(a.circle.node).css({cursor:"pointer"}),$(a.label).css({cursor:"pointer"})),a.breakdownArcs=[];for(b in a.breakdown){var c=a.paper.path("M 0 0 L 2 2").attr({fill:"#fff","fill-opacity":Math.random()*.4+.3,stroke:"#fff"});a.breakdownArcs.push(c)}var d=[a.circle.node,a.label];for(b in a.breakdownArcs)d.push(a.breakdownArcs[b].node);var e=new a.ns.MouseEventGroup(a,d);e.click(a.onclick.bind(a)),e.hover(a.onhover.bind(a)),e.unhover(a.onunhover.bind(a)),a.visible=!0},this.init()},OpenSpendings.BubbleChart.Bubbles.Plain=function(a,b,c,d,e,f){var g=OpenSpendings.BubbleChart,h=g.Utils,i=this;i.className="bubble",i.node=a,i.paper=b.paper,i.origin=c,i.bc=b,i.rad=d,i.angle=e,i.color=f,i.alpha=1,i.visible=!1,i.ns=g,i.bubbleRad=h.amount2rad(this.node.amount),i.childRotation=0,i.getXY=function(){var a=this,b=a.origin,c=a.angle,d=a.rad;a.pos.x=b.x+Math.cos(c)*d,a.pos.y=b.y-Math.sin(c)*d},i.init=function(){var a=this;a.pos=new OpenSpendings.BubbleChart.Vector(0,0),a.getXY();var b=!1;a.initialized=!0},i.onclick=function(a){var b=this;b.node.children.length>0&&b.bc.navigateTo(b.node)},i.onhover=function(a){var b=this;a.node=b.node,a.position={x:b.pos.x,y:b.pos.y},b.bc.onHover(a)},i.onunhover=function(a){var b=this;a.node=b.node,a.position={x:b.pos.x,y:b.pos.y},b.bc.onUnHover(a)},this.draw=function(){var a=this,b=a.bubbleRad*a.bc.bubbleScale,c=a.pos.x,d=a.pos.y,e=a.getXY();!a.visible||(a.circle.attr({cx:a.pos.x,cy:a.pos.y,r:b,"fill-opacity":a.alpha}),a.node.children.length>0?a.dashedBorder.attr({cx:a.pos.x,cy:a.pos.y,r:b-3,"stroke-opacity":a.alpha*.4}):a.dashedBorder.attr({"stroke-opacity":0}),b<20?a.label.hide():(a.label.show(),b<40?a.label.find(".desc").hide():a.label.find(".desc").show()),a.label.css({width:2*b+"px",opacity:a.alpha}),a.label.css({left:a.pos.x-b+"px",top:a.pos.y-a.label.height()*.5+"px"}))},this.hide=function(){var a=this,b;a.circle.remove(),a.dashedBorder.remove(),a.label.remove(),a.visible=!1},this.show=function(){var a=this,b;a.circle=a.paper.circle(a.pos.x,a.pos.y,a.bubbleRad*a.bc.bubbleScale).attr({stroke:!1,fill:a.color}),a.dashedBorder=a.paper.circle(a.pos.x,a.pos.y,a.bubbleRad*a.bc.bubbleScale-3).attr({stroke:"#fff","stroke-opacity":a.alpha*.4,"stroke-dasharray":"- ",fill:!1}),a.label=$('<div class="label"><div class="amount">'+h.formatNumber(a.node.amount)+'</div><div class="desc">'+a.node.label+"</div></div>"),$("#bubble-chart").append(a.label),a.node.children.length>0&&($(a.circle.node).css({cursor:"pointer"}),$(a.label).css({cursor:"pointer"}));var c=[a.circle.node,a.label],d=new a.ns.MouseEventGroup(a,c);d.click(a.onclick.bind(a)),d.hover(a.onhover.bind(a)),d.unhover(a.onunhover.bind(a)),a.visible=!0},this.init()},OpenSpendings.BubbleChart.Layout=function(){var a=this;a.objects=[],a.props=[],a.toHide=[],a.toShow=[],a.$=function(a){var b=this,c,d,e;for(c in b.objects){d=b.objects[c];if(d==a)return b.props[c]}b.objects.push(a),e={},b.props.push(e);return e},a.show=function(a){var b=this;b.toShow.push(a)},a.hide=function(a){var b=this;b.toHide.push(a)}},OpenSpendings.BubbleChart.Line=function(a,b,c,d,e,f){this.bc=a,this.o=c,this.angle=d,this.fromRad=e,this.attr=b,this.toRad=f,this.getXY=function(){this.x1=this.o.x+Math.cos(this.angle)*this.fromRad,this.y1=this.o.y-Math.sin(this.angle)*this.fromRad,this.x2=this.o.x+Math.cos(this.angle)*this.toRad,this.y2=this.o.y-Math.sin(this.angle)*this.toRad},this.init=function(){this.getXY(),console.log("foo","M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2,b),this.path=this.bc.paper.path("M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2).attr(this.attr)},this.draw=function(){this.getXY(),this.path.attr({path:"M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2})},this.init()},OpenSpendings.BubbleChart.MouseEventGroup=function(a,b){var c=this;c.target=a,c.members=b,c.click=function(a){var b=this,c=b.members,d,e;b.clickCallback=a;for(d in c)e=c[d],$(e).click(b.handleClick.bind(b))},c.handleClick=function(a){var b=this;b.clickCallback({target:b.target,origEvent:a,mouseEventGroup:b})},c.hover=function(a){var b=this,c=b.members,d,e;b.hoverCallback=a;for(d in c)e=c[d],$(e).hover(b.handleMemberHover.bind(b),b.handleMemberUnHover.bind(b))},c.unhover=function(a){var b=this;b.unhoverCallback=a},c.wasHovering=!1,c.mouseIsOver=!1,c.handleMemberHover=function(a){var b=this;new vis4.DelayedTask(25,b,b.handleMemberHoverDelayed,a)},c.handleMemberHoverDelayed=function(a){var b=this;b.mouseIsOver=!0,b.wasHovering||(b.wasHovering=!0,$.isFunction(b.hoverCallback)&&b.hoverCallback({target:b.target,origEvent:a,mouseEventGroup:b}))},c.handleMemberUnHover=function(a){var b=this;b.mouseIsOver=!1,new vis4.DelayedTask(40,b,b.handleMemberUnHoverDelayed,a)},c.handleMemberUnHoverDelayed=function(a){var b=this;b.mouseIsOver||(b.wasHovering=!1,$.isFunction(b.unhoverCallback)&&b.unhoverCallback({target:b.target,origEvent:a,mouseEventGroup:b}))},c.addMember=function(a){var b=this;b.hoverCallback&&$(a).hover(b.handleMemberHover.bind(b),b.handleMemberUnHover.bind(b)),b.members.push(a)},c.removeMember=function(a){var b=this,c=b.members,d,e=[];b.clickCallback&&$(a).unbind("click"),b.hoverCallback&&$(a).unbind("mouseenter mouseleave");for(d in c)c[d]!=a&&e.push(c[d]);b.members=e}},OpenSpendings.BubbleChart.Ring=function(a,b,c,d,e){var f=this;f.className="ring",f.rad=d,f.bc=b,f.attr=e,f.origin=c,f.alpha=1,f.visible=!1,f.node=a,f.init=function(){},f.draw=function(){var a=this,b=a.origin;!a.visible||a.circle.attr({cx:b.x,cy:b.y,r:a.rad,"stroke-opacity":a.alpha})},f.hide=function(){var a=this;a.circle.remove(),a.visible=!1},f.show=function(){var a=this;a.circle=a.bc.paper.circle(c.x,c.y,a.rad).attr(a.attr),a.visible=!0,a.circle.toBack()},f.init()},OpenSpendings.BubbleChart.SimpleTransitioner=function(){var a=this;a.garbage=[],a.running=!1,a.changeLayout=function(b){var c,d,e,f;for(c in b.objects){d=b.objects[c];if(d===undefined||d===null)continue;e=b.props[c];for(f in e)d[f]=e[f];$.isFunction(d.draw)&&d.draw(),d.removable&&a.garbage.push(d)}a.collectGarbage()},a.collectGarbage=function(){var a,b,c=this;for(a in c.garbage)b=c.garbage[a],$.isFunction(b.remove)&&b.remove();c.garbage=[]}},OpenSpendings.BubbleChart.AnimatedTransitioner=function(a){var b=this;b.duration=a,b.running=!1,b.changeLayout=function(a){var b,c,d,e,f=this;f.running=!0,f.layout=a;for(b in a.toShow)c=a.toShow[b],$.isFunction(c.show)&&c.show();for(b in a.objects){c=a.objects[b];if(c===undefined||c===null)continue;d=a.props[b];if(f.duration>0){var g=new TWEEN.Tween(c),h={};for(e in d)h[e]=d[e];g.to(h,f.duration),g.easing(TWEEN.Easing.Exponential.EaseOut),$.isFunction(c.draw)&&g.onUpdate(c.draw.bind(c)),b==a.objects.length-1&&g.onComplete(f._completed.bind(f)),g.start()}else for(e in d)c[e]=d[e]}f.duration===0&&f._completed()},b.onComplete=function(a){var b=this;$.isFunction(a)&&b.completeCallbacks.push(a)},b._completed=function(){var a=this,b=a.completeCallbacks,c,d;a.running=!1;for(c in a.layout.objects)d=a.layout.objects[c],$.isFunction(d.draw)&&d.draw();for(c in a.layout.toHide)d=a.layout.toHide[c],$.isFunction(d.hide)&&d.hide();for(c in b)b[c]()}},OpenSpendings.BubbleChart.getTree=function(a,b,c,d,e,f){var g=a,h="";g=g+"/2/aggregate",h="dataset="+b,h=h+"&drilldown="+c.join("|"),d!==undefined&&(d=d.join("|"),h=h+"&cut="+d),f!==undefined?$.ajax({url:f,data:h,dataType:"json",success:e}):$.ajax({url:g,data:h,dataType:"jsonp",jsonpCallback:e})},OpenSpendings.BubbleChart.buildTree=function(a,b,c){var d=a.drilldown,e={},f={id:"root",label:"Total",color:"#555",amount:0,children:[],level:0};c!==undefined&&$.extend(!0,f,c);if(a.errors!==undefined)throw"Error";var g=function(a,c){var d=c.root,e=0;b.forEach(function(b){var f,g;e=e+1,f=a[b];!f||(g=c[f.name],g===undefined?(g={id:f.name,children:[],amount:a.amount,label:f.label,color:f.color,level:e},d.children.push(g),c[f.name]=g):g.amount=g.amount+a.amount,e===1&&(c.root.amount=c.root.amount+a.amount),d=g)})};d.forEach(function(a){g(a,e)});return e.root},OpenSpendings.BubbleChart.getTree=function(a,b,c,d,e,f){var g=a,h="";g=g+"/2/aggregate",h="dataset="+b,h=h+"&drilldown="+c.join("|"),d!==undefined&&(d=d.join("|"),h=h+"&cut="+d),f!==undefined?$.ajax({url:f,data:h,dataType:"json",success:e}):$.ajax({url:g,data:h,dataType:"jsonp",jsonpCallback:e})},OpenSpendings.BubbleChart.buildTree=function(a,b,c){var d=a.drilldown,e={},f={id:"root",label:"Total",color:"#555",amount:0,children:[],level:0};c!==undefined&&$.extend(!0,f,c);if(a.errors!==undefined)throw"Error";var g=function(a,c){var d=c.root,e=0;b.forEach(function(b){var f,g;e=e+1,f=a[b];!f||(g=c[f.name],g===undefined?(g={id:f.name,children:[],amount:a.amount,label:f.label,color:f.color,level:e},d.children.push(g),c[f.name]=g):g.amount=g.amount+a.amount,e===1&&(c.root.amount=c.root.amount+a.amount),d=g)})};d.forEach(function(a){g(a,e)});return e.root},OpenSpendings.BubbleChart.Utils={},OpenSpendings.BubbleChart.Utils.log=function(){try{window.hasOwnProperty("console")&&console.log.apply(this,arguments)}catch(a){}},OpenSpendings.BubbleChart.Utils.amount2rad=function(a){return Math.pow(a/OpenSpendings.BubbleChart.a2radBase,.6)},OpenSpendings.BubbleChart.Utils.formatNumber=function(a){if(a>=1e12)return Math.round(a/1e11)/10+"t";if(a>=1e9)return Math.round(a/1e8)/10+"b";return a>=1e6?Math.round(a/1e5)/10+"m":a}