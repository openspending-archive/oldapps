/*!
 * OpenSpendings BubbleChart 0.1
 *
 * Copyright (c) 2011 Gregor Aisch (http://driven-by-data.net)
 * Licensed under the MIT license
 *//*jshint undef: true, browser:true, jquery: true, devel: true *//*global Raphael, TWEEN */var OpenSpendings=OpenSpendings?OpenSpendings:{};OpenSpendings.BubbleChart=function(a,b){this.container=a,this.dataUrl=b,$(document).ready(function(){this.app=new OpenSpendings.BubbleChart.Main(this.container),this.app.loadData(this.dataUrl)}.bind(this))},OpenSpendings.BubbleChart.Vector=function(a,b){this.x=a,this.y=b,this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},this.normalize=function(a){a||(a=1);var b=this.length();this.x*=a/b,this.y*=a/b}};var log=window.console?console.log:function(a,b,c,d){};OpenSpendings.BubbleChart.Main=function(a){this.$container=$(a),this.ns=OpenSpendings.BubbleChart,this.nodesById={},this.bubbles=[],this.bubbleScale=1,this.loadData=function(a){$.ajax({url:a,dataType:"json",success:this.dataLoaded.bind(this)})},this.dataLoaded=function(a){var b=this;b.initData(a),b.initPaper(),b.initTween(),b.changeView(b.treeRoot.id)},this.initData=function(a){this.traverse(a,0),this.treeRoot=a},this.traverse=function(a,b){var c,d,e;a.data.level===0?a.color="#555":a.data.level==1?(e=a.parent.children,a.color="hsb("+b/e.length+",.8, .8)"):a.color=a.parent.color,a.data.level>0&&(e=a.parent.children,e.length>1&&(a.left=e[(b-1+e.length)%e.length],a.right=e[(Number(b)+1)%e.length],a.right==a.left&&(a.right=undefined)));if(!a.id){a.id=a.label.toLowerCase().replace(/\W/g,"_");while(this.nodesById.hasOwnProperty(a.id))a.id+="_";this.nodesById[a.id]=a}for(c in a.children)d=a.children[c],d.parent=a,this.traverse(d,c)},this.initPaper=function(){var a=this.$container,b=Raphael(a[0],a.width(),a.height()),c=OpenSpendings.BubbleChart.Vector,d=new c(b.width*.5,b.height*.5);this.paper=b,this.origin=d},this.initTween=function(){this.tweenTimer=setInterval(this.loop,1e3/120)},this.changeView=function(a){var b=this,c,d=b.ns,e=d.Utils,f=b.origin,g={stroke:"#ccc","stroke-dasharray":"- "},h={stroke:"#ccc","stroke-dasharray":". "},i=e.amount2rad,j=b.treeRoot,k=b.nodesById,l=k.hasOwnProperty(a)?k[a]:null,m=new d.Layout,n;if(l!==null){e.log("changing view to ",l);for(c in b.bubbles)b.bubbles[c].remove();b.bubbles=[];for(c in b.rings)b.rings[c].remove();b.rings=[];var o=0,p=l.children,q,r,s,t=0,u=Math.PI*2;if(l==j){b.bubbleScale=1,n=b.createBubble(l,m,f,0,0,l.color),b.createRing(m,n.origin,240,g);for(c in p)q=p[c],o+=i(q.data.amount);for(c in p)q=p[c],s=i(q.data.amount)/o*u,r=t+s*.5,t+=s,b.createBubble(q,m,f,240,r,q.color)}else{b.bubbleScale=i(j.data.amount)/i(l.data.amount);var v,w=new d.Vector(b.paper.width*.5-280-b.bubbleScale*(i(l.parent.data.amount)+i(l.data.amount)),f.y);n=b.createBubble(l.parent,m,w,0,0,l.parent.color),b.createRing(m,w,f.x-w.x,h),l.left&&(v=l.left,s=(i(v.data.amount)*b.bubbleScale-100)/(u*(f.x-w.x)),b.createBubble(v,m,n.origin,f.x-w.x,0-Math.asin(b.paper.height*.5/(f.x-w.x))-s,v.color)),l.right&&(v=l.right,s=(i(v.data.amount)*b.bubbleScale-100)/(u*(f.x-w.x)),b.createBubble(v,m,n.origin,f.x-w.x,s+Math.asin((b.paper.height+i(v.data.amount)*b.bubbleScale)*.5/(f.x-w.x)),v.color)),n=b.createBubble(l,m,f,0,0,l.color),b.createRing(m,n.origin,240,g);for(c in p)q=p[c],o+=i(q.data.amount);t-=Math.PI;for(c in p)q=p[c],s=i(q.data.amount)/o*u,r=t+s*.5,t+=s,b.createBubble(q,m,f,240,r,l.color)}e.log("ready"),(new d.SimpleTransitioner).changeLayout(m),e.log("re")}else e.log("node "+a+" not found")},this.createBubble=function(a,b,c,d,e,f){var g=this,h=g.ns,i=new h.Bubble(a,g,new h.Vector(c.x,c.y),0,0,f);g.bubbles.push(i),b.$(i.origin).x=c.x,b.$(i.origin).y=c.y,b.$(i).rad=d,b.$(i).angle=e;return i},this.createRing=function(a,b,c,d){var e=this,f=e.ns,g=new f.Ring(e,b,d,c);e.rings.push(g),a.$(g).rad=c;return g},this.quickPrototype=function(a){var b=this.origin,c=this.paper,d=c.height*.3,e=c.height*.45,f={stroke:"#ccc","stroke-dasharray":"- "},g=OpenSpendings.BubbleChart.amount2rad,h=Math.PI*2/a.children.length;this.l1Circ=new OpenSpendings.BubbleChart.Ring(this,f,d),this.l2Circ=new OpenSpendings.BubbleChart.Ring(this,f,e),this.rootCircle=new OpenSpendings.BubbleChart.Bubble(a,this,0,0,"#555555");var i=0,j,k,l,m,n,o=0,p=0,q=function(a){return Math.round(Raphael.deg(a)*10)/10};for(k in a.children)for(l in a.children[k].children)p+=g(a.children[k].children[l].data.amount);var r=function(a,b){if(a.data.amount==b.data.amount)return 0;return a.data.amount>b.data.amount?-1:1};this.innerRing=[],this.outerRing=[],this.innerLines=[];for(k in a.children){var s=0,t=a.children[k];for(l in t.children)s+=g(t.children[l].data.amount);j=s/p*Math.PI*2,m=i+j*.5,n="hsb("+k/a.children.length+",.8, .8)",this.innerRing.push(new OpenSpendings.BubbleChart.Bubble(t,this,b,d,m,n)),this.innerLines.push(new OpenSpendings.BubbleChart.Line(this,f,b,m,d+g(t.data.amount),e));var u=i,v,w,x=t.children;x.sort(r),t.children=x;var y=u+j*.5,z=y,A=0;for(l in t.children){var B=t.children[l],C=OpenSpendings.BubbleChart.amount2rad(B.data.amount),D=Math.atan(C/e)*2;l===0?(w=y,y-=D+A,z+=D+A):l%2===0?(w=y-D,y-=D+A):(w=z+D,z+=D+A),this.outerRing.push(new OpenSpendings.BubbleChart.Bubble(B,this,e,w,n))}i+=j}},this.scrollTo=function(a){var b=-a.angle,c,d,e,f=this.paper.width*.5,g,h,i=TWEEN.Easing.Exponential.EaseOut,j={};a==this.rootCircle?(h=this.paper.height*.3,e=this.paper.height*.45,g=1):$.inArray(a,this.innerRing)?(h=this.paper.height*1.4,e=this.paper.height*1.8,g=8,f-=h):(h=this.paper.height*.5,e=this.paper.height*.8,f-=e,g=3),Math.abs(b)>Math.PI&&(b+=b>0?-Math.PI*2:Math.PI*2),j.$(this.origin).x=f,j.$(this).bubbleScale=g,j.$(this.rootCircle).foo=1e3;for(c in this.innerRing){d=this.innerRing[c],(new TWEEN.Tween(d)).to({angle:d.angle+b,rad:h},1e3).onUpdate(d.draw.bind(d)).easing(i).start();var k=this.innerLines[c];(new TWEEN.Tween(k)).to({angle:d.angle+b,fromRad:h+d.bubbleRad*g,toRad:e},1e3).onUpdate(k.draw.bind(k)).easing(i).start()}for(c in this.outerRing)d=this.outerRing[c],(new TWEEN.Tween(d)).to({angle:d.angle+b,rad:e},1e3).onUpdate(d.draw.bind(d)).easing(i).start();this.rotation+=b,j.$(this.l1Circ).rad=h,j.$(this.l2Circ).rad=e,j.start()},this.loop=function(){TWEEN.update()},this.updateLayout=function(){var a=this.currentLayout,b=this.nextLayout}},OpenSpendings.BubbleChart.Bubble=function(a,b,c,d,e,f){var g=OpenSpendings.BubbleChart.Utils;this.node=a,this.paper=b.paper,this.origin=c,this.bc=b,this.rad=d,this.angle=e,this.colour=f,this.dirty=!0,this.bubbleRad=g.amount2rad(this.node.data.amount),this.getXY=function(){var a=this,b=a.origin,c=a.angle,d=a.rad;a.x=b.x+Math.cos(c)*d,a.y=b.y-Math.sin(c)*d},this.init=function(){var a=this;a.getXY(),a.circle=a.paper.circle(a.x,a.y,a.bubbleRad*a.bc.bubbleScale).attr({stroke:!1,fill:a.colour}),a.dirty=!1,$(a.circle.node).click(a.onclick.bind(a)),$(a.circle.node).css({cursor:"pointer"});var b=!1;this.label=a.paper.text(a.x,a.y+(b?a.bubbleRad*.4:0),g.formatNumber(a.node.data.amount)+"\n"+a.node.label).attr({"font-family":"Graublau,Georgia,serif",fill:"#fff","font-size":Math.max(4,a.bubbleRad*a.bc.bubbleScale*.25)}),b&&(a.icon=a.paper.path("M17.081,4.065V3.137c0,0,0.104-0.872-0.881-0.872c-0.928,0-0.891,0.9-0.891,0.9v0.9C4.572,3.925,2.672,15.783,2.672,15.783c1.237-2.98,4.462-2.755,4.462-2.755c4.05,0,4.481,2.681,4.481,2.681c0.984-2.953,4.547-2.662,4.547-2.662c3.769,0,4.509,2.719,4.509,2.719s0.787-2.812,4.557-2.756c3.262,0,4.443,2.7,4.443,2.7v-0.058C29.672,4.348,17.081,4.065,17.081,4.065zM15.328,24.793c0,1.744-1.8,1.801-1.8,1.801c-1.885,0-1.8-1.801-1.8-1.801s0.028-0.928-0.872-0.928c-0.9,0-0.957,0.9-0.957,0.9c0,3.628,3.6,3.572,3.6,3.572c3.6,0,3.572-3.545,3.572-3.545V13.966h-1.744V24.793z").translate(this.x,this.y).attr({fill:"#fff",stroke:"none"})),a.initialized=!0},this.onclick=function(a){var b=this;b.bc.changeView(b.node.id)},this.draw=function(){var a=this,b=a.getXY(),c=a.x,d=a.y;a.circle.attr({cx:a.x,cy:a.y,r:a.bubbleRad*a.bc.bubbleScale}),a.label.attr({x:a.x,y:a.y,"font-size":Math.max(4,a.bubbleRad*a.bc.bubbleScale*.25)}),a.icon&&a.icon.translate(a.x-c,a.y-d)},this.remove=function(){var a=this;a.circle.remove(),a.label.remove(),a.initialized=!1,a.icon&&a.icon.remove()},this.init()},OpenSpendings.BubbleChart.Layout=function(){this.objects=[],this.props=[],this.$=function(a){for(var b in this.objects){var c=this.objects[b];if(c==a)return this.props[b]}this.objects.push(a);var d={};this.props.push(d);return d}},OpenSpendings.BubbleChart.Line=function(a,b,c,d,e,f){this.bc=a,this.o=c,this.angle=d,this.fromRad=e,this.attr=b,this.toRad=f,this.getXY=function(){this.x1=this.o.x+Math.cos(this.angle)*this.fromRad,this.y1=this.o.y-Math.sin(this.angle)*this.fromRad,this.x2=this.o.x+Math.cos(this.angle)*this.toRad,this.y2=this.o.y-Math.sin(this.angle)*this.toRad},this.init=function(){this.getXY(),console.log("foo","M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2,b),this.path=this.bc.paper.path("M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2).attr(this.attr)},this.draw=function(){this.getXY(),this.path.attr({path:"M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2})},this.init()},OpenSpendings.BubbleChart.Ring=function(a,b,c,d){this.rad=d,this.bubblechart=a,this.attr=c,this.origin=b,this.init=function(){var a=this.origin;this.circle=this.bubblechart.paper.circle(a.x,a.y,this.rad).attr(this.attr)},this.draw=function(){var a=this.origin;this.circle.attr({cx:a.x,cy:a.y,r:this.rad})},this.remove=function(){var a=this;a.circle.remove()},this.init()},OpenSpendings.BubbleChart.SimpleTransitioner=function(){this.changeLayout=function(a){console.log("hello",a);var b,c,d,e;for(b in a.objects){c=a.objects[b];if(c===undefined||c===null)continue;d=a.props[b];for(e in d)c[e]=d[e];$.isFunction(c.draw)&&c.draw()}}},OpenSpendings.BubbleChart.Utils={},OpenSpendings.BubbleChart.Utils.log=function(){window.console&&console.log.apply(this,arguments)},OpenSpendings.BubbleChart.Utils.amount2rad=function(a){return Math.pow(a/23e8,.6)},OpenSpendings.BubbleChart.Utils.formatNumber=function(a){if(a>=1e12)return Math.round(a/1e11)/10+"t";if(a>=1e9)return Math.round(a/1e8)/10+"b";return a>=1e6?Math.round(a/1e5)/10+"m":a}