<html>
<head>
	<script type="text/javascript" src="../../lib/vendor/jquery-1.5.2.min.js"></script>
	<script type="text/javascript" src="../../lib/vendor/jquery.history.js"></script>
	<script type="text/javascript" src="../../lib/vendor/raphael.js"></script>
	<script type="text/javascript" src="../../lib/vendor/vis4.js"></script>
	<script type="text/javascript" src="../../lib/vendor/Tween.js"></script>
	<script type="text/javascript" src="bubblechart.min.js"></script>
	<style type="text/css">

	html, body { background: #ddd; margin: 0; height: 100%; width: 100%; padding: 0; }
	
	#demo-frame {
		width: 1035px; margin: 0 auto; height: 900px; background: url(os-frame.png) no-repeat; position: relative;
	}
	
	#bubble-chart-wrapper { width: 723px; height: 616px; position: absolute; left: 44px; top: 182px; }
	#bubble-chart { background: #fff; position: relative; height: 100%; overflow: hidden; }
	#bubble-chart .label { position: absolute; color: #fff; text-align: center; cursor: default; }
	#bubble-chart .amount { font-family: Graublau, Georgia, sans; font-size: 16px; }
	#bubble-chart .desc { font-family: sans-serif; font-size: 11px }
	
	#bubble-chart-wrapper .tooltip { max-width: 220px;  border: 1px solid #999; 
		position: absolute; background: #fff; z-index: 9999;
		box-shadow: 3px 3px 0px rgba(0,0,0,.2); border-radius: 2px;
		font-family: sans-serif; font-size: 11px;
	}
	
	#bubble-chart-wrapper .tooltip .header {
		padding: 6px;
	}
	
	#bubble-chart-wrapper .tooltip .header .icon {
		width: 38px;
		height: 38px;
		float: left;
		background: #600;
		border-radius: 19px;
		margin-right: 8px;
	}
	
	#bubble-chart-wrapper .tooltip .row {
		clear: both;
		border-top: 1px solid #999; padding: 6px;
	}

	@font-face {
		font-family: Graublau;
		src: url('fonts/graublau/GraublauWeb.otf') format("opentype");
	}
	
	</style>
	<script type="text/javascript">
       
		var buildBubbleChart = function(data) {
			
			var style = {
				'root': { // Total
					color: '#999999'
				},
				'10': { // Helping Others
					color: '#f4714c'
				},
				'02': { // Defence
					color: '#999933'
				},
				'05': { // Environment
					color: '#006633'
				},
				'07': { // Health
					color: '#cc0066'
				},
				'03': { // Order & Safety
					color: '#0099cc'
				},
				'06': { // Our Streets
					color: '#cc6666'
				},
				'08': { // Culture
					color: '#cccc00'
				},
				'01': { // Running Government
					color: '#9900cc'
				},
				'09': { // Education
					color: '#3333cc'
				},
				'04': { // Country, Social Systems
					color: '#33cc33'
				}
			};
			
			var tooltipTimer;
			/*
			 * this function is called by the bubbles if the user hovers over them
			 */
			var setTooltip = function(event) {
				var tt = $('#bubble-chart-wrapper .tooltip'), tthtml = '<div class="header"><div class="icon"></div><div class="title">'
					+event.node.label+' ('+event.node.id+')</div><div class="amount">'
					+OpenSpendings.BubbleChart.Utils.formatNumber(event.node.amount)+'&euro;</div></div>'
					+'<div class="row"><a>More Information</a></div>'
					+'<div class="row"><a>Add to Compare-O-Tron</a></div>';
				
				if (tt.length > 0) {
					tt.html(tthtml);
				} else {
					tt = $('<div class="tooltip">'+tthtml+'</div>');
					$('#bubble-chart-wrapper').append(tt);
				}
				$('#bubble-chart-wrapper .tooltip .icon').css({ background: event.target.color });
				vis4.log(event.target.color);
				event.mouseEventGroup.addMember(tt);
				tt.css({ left: (event.position.x-tt.width()*0.5)+'px', top: (event.position.y+ 10)+'px', opacity: 0 });
				tooltipTimer = new vis4.DelayedTask(2000, this, showTooltip, tt);
			};
			
			/*
			 * shows a tooltip, is called delayed
			 */
			var showTooltip = function(tt) {
				tt.animate({ opacity: 1 }, { duration: 300 });
				tt.show();
			};
			
			/*
			 * hides the tooltip for a specific node
			 */
			var hideTooltip = function(event) {
				var tt = $('#bubble-chart-wrapper .tooltip');
				tt.css({ opacity: 0, left: '-500px' });
				tt.hide();
				event.mouseEventGroup.removeMember(tt);
				tooltipTimer.cancel();
			};
			
			// initialize bubble chart
			window.bubbleChart = new OpenSpendings.BubbleChart(
				'#bubble-chart', 
				data, 
				setTooltip, 
				hideTooltip,
				style
			);       
       	};

        var api_url = 'http://127.0.0.1:5000/api/';
        var dataset = 'cra'
        var drilldowns = ['cofog1', 'cofog2', 'cofog3'];
        var cuts = ['time.from.year:2009'];
        var rootNode = {label: 'Grant Total'};
        // We test with test data. To use it with a  wdmmg instance.
        // set testDataPath to undefined. and use change the
        // buildBubbleChartCallback to 'buildBubbleChartCallback'
        var testDataPath = undefined;//'data/example-aggregate.json';
                                        
        var buildBubbleChartCallback = function(data) {
            var tree = OpenSpendings.BubbleChart.buildTree(data, drilldowns,
                                                           rootNode);
            buildBubbleChart(tree);
        };

        OpenSpendings.BubbleChart.getTree(api_url, dataset,
                                          drilldowns, cuts,
                                          buildBubbleChartCallback,
                                          rootNode, testDataPath);
                                        
	</script>
</head>
<body>
	<div id="demo-frame">
		<div id="bubble-chart-wrapper">
			<div id="bubble-chart"></div>
		</div>
	</div>
</body>
</html>
